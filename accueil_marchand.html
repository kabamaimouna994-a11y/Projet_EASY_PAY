<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EASY-PAY Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --wave-orange: #ff8c00; --text-dark: #2c3e50; --bg-light: #f0f2f5; --success: #27ae60; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-light); display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }

        .nav-header { width: 100%; max-width: 450px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .logo { color: var(--wave-orange); font-weight: 800; font-size: 22px; }

        /* LE BOX UNIQUE */
        .main-box { 
            background: white; 
            width: 100%; 
            max-width: 450px; 
            height: 80vh; 
            border-radius: 35px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; /* Important pour le bouton flottant */
        }

        /* NAVIGATION DE RACCOURCIS */
        .box-nav { 
            display: flex; 
            justify-content: space-around; 
            padding: 15px; 
            background: #fff; 
            border-bottom: 1px solid #f0f0f0; 
            z-index: 10;
        }
        .box-nav a { text-decoration: none; color: #888; font-size: 11px; font-weight: 700; transition: 0.3s; }
        .box-nav a:hover { color: var(--wave-orange); }

        /* ZONE DE SCROLL */
        .box-content { flex: 1; overflow-y: auto; padding: 25px; scroll-behavior: smooth; }

        .section { padding-bottom: 40px; border-bottom: 1px solid #f8f9fa; margin-bottom: 30px; }
        .qr-area { text-align: center; }
        .qr-area img { width: 180px; border: 10px solid #f9f9f9; border-radius: 20px; margin: 15px 0; }
        
        .total-card { background: var(--success); color: white; padding: 20px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .trans-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f9f9f9; }

        /* BOUTON RETOUR EN HAUT (INTERNE) */
        #btn-top {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: var(--text-dark);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none; /* Caché par défaut */
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .btn-print { width: 100%; padding: 14px; background: var(--text-dark); color: white; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="nav-header">
    <div class="logo">EASY-PAY</div>
    <button onclick="logout()" style="border:none; background:none; font-weight:700; color:#666; cursor:pointer;">Quitter</button>
</div>

<div class="main-box">
    <div class="box-nav">
        <a href="#sec-qr">MON QR</a>
        <a href="#sec-stats">STATISTIQUES</a>
        <a href="#sec-history">VENTES</a>
    </div>

    <button id="btn-top" onclick="scrollToTop()">↑</button>

    <div class="box-content" id="scroll-zone">
        
        <div id="sec-qr" class="section qr-area">
            <h2 id="display-name" style="margin:0; font-size:20px;">Chargement...</h2>
            <p id="display-code" style="color:#aaa; font-size:12px;">ID: --</p>
            <img id="qr-img" src="" alt="QR">
            <button class="btn-print" onclick="window.print()">Imprimer mon QR</button>
        </div>

        <div id="sec-stats" class="section">
            <h4 style="margin:0 0 15px 0; font-size:14px; color:var(--text-dark);">Analytique</h4>
            <div class="total-card">
                <span>TOTAL ENCAISSÉ</span>
                <strong id="total-valeur">0 F</strong>
            </div>
            <canvas id="salesChart"></canvas>
        </div>

        <div id="sec-history" class="section" style="border:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 style="margin:0; font-size:14px;">Historique</h4>
                <span onclick="loadData()" style="color:var(--wave-orange); cursor:pointer; font-size:11px; font-weight:bold;">ACTUALISER ↻</span>
            </div>
            <div id="transactions-list"></div>
        </div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost/Projet_easypay/';
    let myChart = null;
    const scrollZone = document.getElementById('scroll-zone');
    const btnTop = document.getElementById('btn-top');

    // Détection du scroll pour afficher le bouton "Haut"
    scrollZone.onscroll = function() {
        if (scrollZone.scrollTop > 200) {
            btnTop.style.display = "block";
        } else {
            btnTop.style.display = "none";
        }
    };

    function scrollToTop() {
        scrollZone.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.onload = function() {
        const name = sessionStorage.getItem('ep_marchand_fixed_name');
        const code = sessionStorage.getItem('ep_marchand_fixed_code');
        if(!code) window.location.href = 'marchand.html';
        document.getElementById('display-name').innerText = name;
        document.getElementById('display-code').innerText = "ID: " + code;
        document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${code}`;
        loadData();
    };

    async function loadData() {
        const mCode = sessionStorage.getItem('ep_marchand_fixed_code');
        try {
            const res = await fetch(API_BASE + 'api_marchand.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'historique', merchant_code: mCode })
            });
            const data = await res.json();
            if (data.success) {
                renderTransactions(data.transactions);
                renderChart(data.transactions);
            }
        } catch (e) { console.error("Erreur"); }
    }

    function renderTransactions(transactions) {
        const list = document.getElementById('transactions-list');
        let total = 0;
        list.innerHTML = transactions.map(t => {
            total += parseFloat(t.amount);
            return `<div class="trans-item">
                <div style="text-align:left">
                    <div style="font-weight:700; font-size:13px;">${t.client_name}</div>
                    <div style="font-size:10px; color:#aaa;">${t.date}</div>
                </div>
                <div style="font-weight:800; color:var(--success); font-size:14px;">+ ${parseFloat(t.amount).toLocaleString()} F</div>
            </div>`;
        }).join('');
        document.getElementById('total-valeur').innerText = total.toLocaleString() + " F";
    }

    function renderChart(transactions) {
        const dataRev = [...transactions].reverse();
        const ctx = document.getElementById('salesChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataRev.map(t => t.date.split(' ')[1]),
                datasets: [{ 
                    data: dataRev.map(t => t.amount), 
                    borderColor: '#ff8c00', 
                    fill: true, 
                    backgroundColor: 'rgba(255, 140, 0, 0.1)', 
                    tension: 0.4,
                    borderWidth: 2
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });
    }

    function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }
</script>
</body>
</html>